$(document).ready(function(){function t(e){var t=e.substring(1,e.length-1),o=t.split(/],\[+/g);return o}function o(){_=[];var e=600*Math.random(),t=600*Math.random(),o=600*Math.random();_.push(e,t,o),I=JSON.stringify(_),$.ajax({url:"espace-membre/script.php",type:"POST",data:{userPosition:I,action:"setPositionShape"},complete:function(e,t){console.log(t)}})}function n(){y=[];for(var e=0;4>e;e++){var t=-15+Math.round(30*Math.random()),o=-15+Math.round(30*Math.random()),n=-15+Math.round(30*Math.random());y.push(new THREE.Vector3(t,o,n))}a()}function a(){x=new THREE.Object3D;var e=new THREE.MeshBasicMaterial({color:16777215,transparent:!1});y.forEach(function(t){var o=new THREE.SphereGeometry(.2),n=new THREE.Mesh(o,e);n.position.copy(t),x.add(n)}),H=new THREE.ConvexGeometry(y),w=new THREE.Mesh(H,new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.14})),f.add(w)}function r(e){"chat"==e?$(".container-modal-chat").fadeIn(400):"welcome"==e&&$(".modal-welcome").fadeIn(400),b.lookSpeed=.01}function s(){return $.ajax({url:"espace-membre/script.php",type:"POST",data:{action:"getMessage",id_conversation:k,lastid:q},success:function(e){var t=$.parseJSON(e);null!=t.msg&&null!=t.id&&($(".chatroom").append("<li>"+t.msg+"</li>"),q=t.id),$(".chatroom li").length>1&&$(".chatroom li:first-child").remove()}}),!1}function c(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=getNotification",success:function(e){var t=$.parseJSON(e);null!=t&&(console.log("Notification : "+t.id_room[0]),D=t.id_room[0],$(".popup").fadeIn(400))}})}function p(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setStatistics",success:function(t){var o=$.parseJSON(t),n=o.nbr_shapes,a=o.nbr_shapes_connected,r=o.nbr_link_created,s=o.nbr_linkPerso_created,c=o.nbr_msg_sended,p=o.user_connected;if(z=o.user_recept,S=o.user_emit,B=[],B.push(X),null!=o.user_recept&&null!=o.user_emit)for(console.log(z),console.log(S),e=0;e<o.user_recept.length;e++){var l=new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.3}),m=new THREE.Mesh(new THREE.SphereGeometry(2,5,5),l);m.position.set(J[S[e]].position.x,J[S[e]].position.y,J[S[e]].position.z),m.name="shape_transit",f.add(m),O=new TWEEN.Tween({x:m.position.x,y:m.position.y,z:m.position.z}).to({x:J[z[e]].position.x,y:J[z[e]].position.y,z:J[z[e]].position.z},4e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){m.position.x=this.x,m.position.y=this.y,m.position.z=this.z}).onComplete(function(){f.remove(m)}).start()}for(i=0;i<p.length;i++){var u=p[i];B.push(J[u]),B[i].material.opacity=.2}$(".chiffre1").html(n),$(".chiffre2").html(a),$(".chiffre3").html(r),$(".chiffre4").html(s),$(".chiffre5").html(c)}})}function l(){$.ajax({url:"espace-membre/script.php",type:"POST",data:{ID:N,action:"removeNotif"}})}function m(){requestAnimationFrame(m),T=g.getDelta(),b.update(T),TWEEN.update(),d.clear(),d.render(f,E)}function u(e){et||tt||$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}})}var h,d,f,E,v,x,w,y,T,g,b,H,R,M,z,S,O,_,I,N,C,P,j,k,Y,W,D,V,L,G,J=[],F=[],B=[],q=0,U=!0,A=!1;d=new THREE.WebGLRenderer,f=new THREE.Scene,g=new THREE.Clock,E=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e4),E.position.set(0,0,0),E.target=f.position.clone(),d.setClearColor(new THREE.Color(16777215,1)),d.shadowMapEnabled=!0,d.setSize(window.innerWidth,window.innerHeight),h=document.getElementById("container-exp-1"),h.appendChild(d.domElement),h.focus(),f.add(E),b=new THREE.FirstPersonControls(E,h),b.lookSpeed=.05,b.movementSpeed=170,b.noFly=!1,b.activeLook=!0,b.lookVertical=!0,b.constrainVertical=!1,b.verticalMin=0,b.verticalMax=0,b.lon=-150,b.lat=120,$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=newMember",success:function(e){var t=$.parseJSON(e);A=t.new_member,A===!0&&(o(),$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=activeMember"}))},complete:function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setMatrix",success:function(e){for(Y=$.parseJSON(e),W=Y.position,C=W.length,i=0;C>i;i++){n();var o=t(W[i]),a=o[0].split(/,+/g);w.position.x=+a[0],w.position.y=+a[1],w.position.z=+a[2],w.name=i+1,J.push(w)}if(void 0!=Y.user_a)for(i=0;i<Y.user_a.length;i++){L=Y.user_a[i],G=Y.user_b[i];var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(J[+L].position.x,J[+L].position.y,J[+L].position.z),new THREE.Vector3(J[+G].position.x,J[+G].position.y,J[+G].position.z));for(var s=0;s<r.vertices.length;s++)r.colors[s]=new THREE.Color(Math.random(),Math.random(),Math.random());var c=new THREE.Line(r,new THREE.LineBasicMaterial({transparent:!0,opacity:.2,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);f.add(c)}p()},complete:function(e){N=+Y.ID;var t=J[N];t.material.wireframe=!0,t.material.wireframeLinewidth=1,t.material.opacity=.2,t.scale.x,t.scale.y,t.scale.z=3,O=new TWEEN.Tween({x:E.position.x,y:E.position.y,z:E.position.z}).to({x:t.position.x,y:t.position.y,z:t.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){E.position.x=this.x,E.position.y=this.y,E.position.z=this.z}).onComplete(function(){A===!0&&r("welcome")}).start()}})}});var K=new THREE.MeshPhongMaterial({color:6052956,ambient:15132390,emissive:3618615,specular:8224125}),X=new THREE.Mesh(new THREE.BoxGeometry(20,20,20),K);X.position.set(0,0,0),X.name="logout",f.add(X),J.push(X),d.render(f,E),$(h).click(function(e){e.preventDefault();var t=new THREE.Vector3(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1,.5);t=t.unproject(E);var o=new THREE.Raycaster(E.position,t.sub(E.position).normalize()),n=o.intersectObjects(J);n.length>0&&n[0].object!=J[N]&&(M=n[0].object,P=M.name,"logout"==P?$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}}):(console.log("ID Forme sélectionnée : "+P),console.log("ID personnel : "+N),$.ajax({url:"espace-membre/script.php",type:"POST",data:{name_object:P,action:"createDiscussion"},success:function(e){$("#fiche").html("");var t=$.parseJSON(e),o=t.information;k=t.id_conversation,console.log(o),null!=o?($("#fiche").html(""),$("#fiche").val(o),console.log("Information fiche : "+o)):$("#fiche").val(""),console.log("ID conversation : "+k),j=setInterval(s,3e3),clearInterval(Q)}}),E.position.x!=M.position.x&&E.position.y!=M.position.y?O=new TWEEN.Tween({x:E.position.x,y:E.position.y,z:E.position.z}).to({x:M.position.x,y:M.position.y,z:M.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){E.position.x=this.x,E.position.y=this.y,E.position.z=this.z}).onComplete(function(){r("chat"),$(".statistiques").css({"-webkit-transform":"translateY(90px)","-moz-transform":"translateY(90px)","-ms-transform":"translateY(90px)","-o-transform":"translateY(90px)",transform:"translateY(90px)"})}).start():(r("chat"),$(".statistiques").css({"-webkit-transform":"translateY(90px)","-moz-transform":"translateY(90px)","-ms-transform":"translateY(90px)","-o-transform":"translateY(90px)",transform:"translateY(90px)"}))))}),$(".md-close").click(function(){return Q=setInterval(c,1e4),clearInterval(j),b.lookSpeed=.05,$(".chatroom li").remove(),$(".container-modal-chat").fadeOut(400),$(".modal-welcome").fadeOut(400),$(".statistiques").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),l(),h.focus(),!1}),$(".disconnect").click(function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}})}),$("#chatForm").submit(function(e){e.preventDefault();var t=$("#message").val();return R=1,t.length>130?($(".text-lenght").html(t.length),$(".error-length").fadeIn(400),!1):(""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{message:t,action:"sendMessage",id_conversation:k,notif:R,name_object:P},success:function(e){s(),$("#message").val(""),$("#message").focus();var t=new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.2}),o=new THREE.Mesh(new THREE.SphereGeometry(2,5,5),t);o.position.set(J[N].position.x,J[N].position.y,J[N].position.z),o.name="shape_transit",f.add(o);var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(J[N].position.x,J[N].position.y,J[N].position.z),new THREE.Vector3(M.position.x,M.position.y,M.position.z));for(var i=0;i<n.vertices.length;i++)n.colors[i]=new THREE.Color(Math.random(),Math.random(),Math.random());var a=new THREE.Line(n,new THREE.LineBasicMaterial({transparent:!0,opacity:.3,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);f.add(a),O=new TWEEN.Tween({x:o.position.x,y:o.position.y,z:o.position.z}).to({x:M.position.x,y:M.position.y,z:M.position.z},4e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){o.position.x=this.x,o.position.y=this.y,o.position.z=this.z}).onComplete(function(){f.remove(o)}).start()}})),$(".chatroom li").length>=1&&$(".chatroom li:first-child").remove(),!1)}),$("#chatFiche").submit(function(e){e.preventDefault();var t=$("#fiche").val();return t.length>430?($(".text-lenght").html(t.length),$(".error-length").fadeIn(400),!1):void(""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{information:t,action:"setInformation",id_conversation:k},success:function(e){var e=$.parseJSON(e),t=e.infos;$(".save-informations").fadeIn(400).delay(5e3).fadeOut(400)}})))});var Q=setInterval(c,1e4);setInterval(p,1e4),$(".left-button").click(function(){k=D,clearInterval(Q),j=setInterval(s,3e3),$(".popup").fadeOut(400),r("chat"),l()}),$(".right-button").click(function(){$(".popup").fadeOut(400),l()}),m();var Z=new Konami(function(){function e(){var e=16729156*Math.random();d.setClearColor(new THREE.Color(e,1))}var t=new Audio("sound/nightmare.wav");t.loop=!0,t.play(),setInterval(e,100)});THREEx.WindowResize(d,E);var et,tt;$("body").mouseleave(function(e){et=0,tt=0}),$("body").mouseenter(function(e){et=1,tt=1}),window.onbeforeunload=u});
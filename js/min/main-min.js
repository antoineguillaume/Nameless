$(document).ready(function(){function t(e){var t=e.substring(1,e.length-1),o=t.split(/],\[+/g);return o}function o(){I=[];var e=600*Math.random(),t=600*Math.random(),o=600*Math.random();I.push(e,t,o),N=JSON.stringify(I),$.ajax({url:"espace-membre/script.php",type:"POST",data:{userPosition:N,action:"setPositionShape"},complete:function(e,t){console.log(t)}})}function n(){T=[];for(var e=0;4>e;e++){var t=-15+Math.round(30*Math.random()),o=-15+Math.round(30*Math.random()),n=-15+Math.round(30*Math.random());T.push(new THREE.Vector3(t,o,n))}r()}function r(){x=new THREE.Object3D;var e=new THREE.MeshBasicMaterial({color:16777215,transparent:!1});T.forEach(function(t){var o=new THREE.SphereGeometry(.2),n=new THREE.Mesh(o,e);n.position.copy(t),x.add(n)}),b=new THREE.ConvexGeometry(T),y=new THREE.Mesh(b,new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.14})),E.add(y)}function s(e){"chat"==e?$(".container-modal-chat").fadeIn(400):"welcome"==e&&$(".modal-welcome").fadeIn(400),R.lookSpeed=.01}function c(){return $.ajax({url:"espace-membre/script.php",type:"POST",data:{action:"getMessage",id_conversation:k,lastid:U},success:function(e){var t=$.parseJSON(e);null!=t.msg&&null!=t.id&&($(".chatroom").append("<li>"+t.msg+"</li>"),U=t.id),$(".chatroom li").length>1&&$(".chatroom li:first-child").remove()}}),!1}function p(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=getNotification",success:function(e){var t=$.parseJSON(e);null!=t&&(console.log("Notification : "+t.id_room[0]),V=t.id_room[0],$(".popup").fadeIn(400))}})}function l(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setStatistics",success:function(t){var o=$.parseJSON(t),n=o.nbr_shapes,r=o.nbr_shapes_connected,s=o.nbr_link_created,c=o.nbr_linkPerso_created,p=o.nbr_msg_sended,l=o.user_connected;if(S=o.user_recept,O=o.user_emit,q=[],q.push(Q),null!=o.user_recept&&null!=o.user_emit)for(e=0;e<o.user_recept.length;e++){var m=new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.4}),u=new THREE.Mesh(new THREE.SphereGeometry(2,5,5),m);u.position.set(F[O[e]].position.x,F[O[e]].position.y,F[O[e]].position.z),u.name="shape_transit",E.add(u),_=new TWEEN.Tween({x:u.position.x,y:u.position.y,z:u.position.z}).to({x:F[S[e]].position.x,y:F[S[e]].position.y,z:F[S[e]].position.z},4e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){u.position.x=this.x,u.position.y=this.y,u.position.z=this.z}).onComplete(function(){E.remove(u)}).start()}for(a=0;a<F.length;a++)F[a].material.opacity=.14;for(i=0;i<l.length;i++){var h=l[i];q.push(F[h]),q[i+1].material.opacity=.4}$(".chiffre1").html(n),$(".chiffre2").html(r),$(".chiffre3").html(s),$(".chiffre4").html(c),$(".chiffre5").html(p)}})}function m(){$.ajax({url:"espace-membre/script.php",type:"POST",data:{ID:C,action:"removeNotif"}})}function u(){requestAnimationFrame(u),g=H.getDelta(),R.update(g),TWEEN.update(),f.clear(),f.render(E,v)}function h(e){tt||ot||$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}})}var d,f,E,v,w,x,y,T,g,H,R,b,M,z,S,O,_,I,N,C,P,j,Y,k,W,D,V,L,G,J,F=[],B=[],q=[],U=0,A=!0,K=!1;f=new THREE.WebGLRenderer,E=new THREE.Scene,H=new THREE.Clock,v=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e4),v.position.set(0,0,0),v.target=E.position.clone(),f.setClearColor(new THREE.Color(16777215,1)),f.shadowMapEnabled=!0,f.setSize(window.innerWidth,window.innerHeight),d=document.getElementById("container-exp-1"),d.appendChild(f.domElement),d.focus(),E.add(v),R=new THREE.FirstPersonControls(v,d),R.lookSpeed=.05,R.movementSpeed=170,R.noFly=!1,R.activeLook=!0,R.lookVertical=!0,R.constrainVertical=!1,R.verticalMin=0,R.verticalMax=0,R.lon=-150,R.lat=120,$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=newMember",success:function(e){var t=$.parseJSON(e);K=t.new_member,K===!0&&(o(),$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=activeMember"}))},complete:function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setMatrix",success:function(e){for(W=$.parseJSON(e),D=W.position,P=D.length,i=0;P>i;i++){n();var o=t(D[i]),a=o[0].split(/,+/g);y.position.x=+a[0],y.position.y=+a[1],y.position.z=+a[2],y.name=i+1,F.push(y)}if(void 0!=W.user_a)for(i=0;i<W.user_a.length;i++){G=W.user_a[i],J=W.user_b[i];var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(F[+G].position.x,F[+G].position.y,F[+G].position.z),new THREE.Vector3(F[+J].position.x,F[+J].position.y,F[+J].position.z));for(var s=0;s<r.vertices.length;s++)r.colors[s]=new THREE.Color(Math.random(),Math.random(),Math.random());var c=new THREE.Line(r,new THREE.LineBasicMaterial({transparent:!0,opacity:.3,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);E.add(c)}l()},complete:function(e){C=+W.ID;var t=F[C];t.material.wireframe=!0,t.material.wireframeLinewidth=1,t.material.opacity=.2,t.scale.x,t.scale.y,t.scale.z=3,_=new TWEEN.Tween({x:v.position.x,y:v.position.y,z:v.position.z}).to({x:t.position.x,y:t.position.y,z:t.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){v.position.x=this.x,v.position.y=this.y,v.position.z=this.z}).onComplete(function(){K===!0&&s("welcome")}).start()}})}});var X=new THREE.MeshPhongMaterial({color:6052956,ambient:15132390,emissive:3618615,specular:8224125}),Q=new THREE.Mesh(new THREE.BoxGeometry(20,20,20),X);Q.position.set(0,0,0),Q.name="logout",E.add(Q),F.push(Q),f.render(E,v),$(d).click(function(e){e.preventDefault();var t=new THREE.Vector3(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1,.5);t=t.unproject(v);var o=new THREE.Raycaster(v.position,t.sub(v.position).normalize()),n=o.intersectObjects(q);n.length>0&&n[0].object!=F[C]&&(z=n[0].object,j=z.name,"logout"==j?$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}}):(console.log("ID Forme sélectionnée : "+j),console.log("ID personnel : "+C),$.ajax({url:"espace-membre/script.php",type:"POST",data:{name_object:j,action:"createDiscussion"},success:function(e){$("#fiche").html("");var t=$.parseJSON(e),o=t.information;k=t.id_conversation,console.log(o),null!=o?($("#fiche").html(""),$("#fiche").val(o),console.log("Information fiche : "+o)):$("#fiche").val(""),console.log("ID conversation : "+k),Y=setInterval(c,3e3),clearInterval(Z)}}),v.position.x!=z.position.x&&v.position.y!=z.position.y?_=new TWEEN.Tween({x:v.position.x,y:v.position.y,z:v.position.z}).to({x:z.position.x,y:z.position.y,z:z.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){v.position.x=this.x,v.position.y=this.y,v.position.z=this.z}).onComplete(function(){s("chat"),$(".statistiques").css({"-webkit-transform":"translateY(90px)","-moz-transform":"translateY(90px)","-ms-transform":"translateY(90px)","-o-transform":"translateY(90px)",transform:"translateY(90px)"})}).start():(s("chat"),$(".statistiques").css({"-webkit-transform":"translateY(90px)","-moz-transform":"translateY(90px)","-ms-transform":"translateY(90px)","-o-transform":"translateY(90px)",transform:"translateY(90px)"}))))}),$(".md-close").click(function(){return Z=setInterval(p,1e4),clearInterval(Y),R.lookSpeed=.05,$(".chatroom li").remove(),$(".container-modal-chat").fadeOut(400),$(".modal-welcome").fadeOut(400),$(".statistiques").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),m(),d.focus(),!1}),$("#chatForm").submit(function(e){e.preventDefault();var t=$("#message").val();return M=1,t.length>130?($(".text-lenght").html(t.length),$(".error-length").fadeIn(400),!1):(""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{message:t,action:"sendMessage",id_conversation:k,notif:M,name_object:j},success:function(e){c(),$("#message").val(""),$("#message").focus();var t=new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.3}),o=new THREE.Mesh(new THREE.SphereGeometry(2,5,5),t);o.position.set(F[C].position.x,F[C].position.y,F[C].position.z),o.name="shape_transit",E.add(o);var n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(F[C].position.x,F[C].position.y,F[C].position.z),new THREE.Vector3(z.position.x,z.position.y,z.position.z));for(var i=0;i<n.vertices.length;i++)n.colors[i]=new THREE.Color(Math.random(),Math.random(),Math.random());var a=new THREE.Line(n,new THREE.LineBasicMaterial({transparent:!0,opacity:.3,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);E.add(a),_=new TWEEN.Tween({x:o.position.x,y:o.position.y,z:o.position.z}).to({x:z.position.x,y:z.position.y,z:z.position.z},4e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){o.position.x=this.x,o.position.y=this.y,o.position.z=this.z}).onComplete(function(){E.remove(o)}).start()}})),$(".chatroom li").length>=1&&$(".chatroom li:first-child").remove(),!1)}),$("#chatFiche").submit(function(e){e.preventDefault();var t=$("#fiche").val();""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{information:t,action:"setInformation",id_conversation:k},success:function(e){var e=$.parseJSON(e),t=e.infos;$(".save-informations").fadeIn(400).delay(5e3).fadeOut(400)}}))});var Z=setInterval(p,1e4);setInterval(l,1e4),$(".left-button").click(function(){k=V,clearInterval(Z),Y=setInterval(c,3e3),$(".popup").fadeOut(400),s("chat"),m()}),$(".right-button").click(function(){$(".popup").fadeOut(400),m()}),u();var et=new Konami(function(){function e(){var e=16729156*Math.random();f.setClearColor(new THREE.Color(e,1))}var t=new Audio("sound/nightmare.wav");t.loop=!0,t.play(),setInterval(e,100)});THREEx.WindowResize(f,v);var tt,ot;$("body").mouseleave(function(e){tt=0,ot=0}),$("body").mouseenter(function(e){tt=1,ot=1}),window.onbeforeunload=h});
$(document).ready(function(){function e(e){var t=e.substring(1,e.length-1),o=t.split(/],\[+/g);return o}function t(){S=[];var e=600*Math.random(),t=600*Math.random(),o=600*Math.random();S.push(e,t,o),O=JSON.stringify(S),$.ajax({url:"espace-membre/script.php",type:"POST",data:{userPosition:O,action:"setPositionShape"},complete:function(e,t){console.log(t)}})}function o(){T=[];for(var e=0;4>e;e++){var t=-15+Math.round(30*Math.random()),o=-15+Math.round(30*Math.random()),i=-15+Math.round(30*Math.random());T.push(new THREE.Vector3(t,o,i))}n()}function n(){w=new THREE.Object3D;var e=new THREE.MeshBasicMaterial({color:16777215,transparent:!1});T.forEach(function(t){var o=new THREE.SphereGeometry(.2),n=new THREE.Mesh(o,e);n.position.copy(t),w.add(n)}),H=new THREE.ConvexGeometry(T),x=new THREE.Mesh(H,new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.08})),f.add(x)}function a(e){"chat"==e?$(".modal-chat").fadeIn(400):"welcome"==e&&$(".modal-welcome").fadeIn(400),$("#container-exp-1").css({"-webkit-filter":"blur(15px)","-moz-filter":"blur(15px)","-ms-filter":"blur(15px)","-o-filter":"blur(15px)",filter:"blur(15px)"}),g.lookSpeed=.01}function r(){return $.ajax({url:"espace-membre/script.php",type:"POST",data:{action:"getMessage",id_conversation:C,lastid:B},success:function(e){var t=$.parseJSON(e);null!=t.msg&&null!=t.id&&($(".chatroom").append("<li>"+t.msg+"</li>"),B=t.id),$(".chatroom li").length>1&&$(".chatroom li:first-child").remove()}}),!1}function s(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=getNotification",success:function(e){var t=$.parseJSON(e);null!=t&&(console.log("Notification : "+t.id_room[0]),k=t.id_room[0],$(".popup").fadeIn(400))}})}function c(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isConnected",success:function(e){var t=$.parseJSON(e),o=t.user_connected;for(G=[],G.push(A),i=0;i<o.length;i++){var n=o[i];G.push(L[n]),G[i].material.opacity=.2}}})}function p(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setStatistics",success:function(e){var t=$.parseJSON(e),o=t.nbr_shapes,n=t.nbr_shapes_connected,i=t.nbr_link_created,a=t.nbr_linkPerso_created,r=t.nbr_msg_sended;$(".chiffre1").html(o),$(".chiffre2").html(n),$(".chiffre3").html(i),$(".chiffre4").html(a),$(".chiffre5").html(r)}})}function l(){$.ajax({url:"espace-membre/script.php",type:"POST",data:{ID:z,action:"removeNotif"}})}function u(){requestAnimationFrame(u),b=y.getDelta(),g.update(b),TWEEN.update(),h.clear(),h.render(f,E)}function m(e){Y||K||$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}})}var d,h,f,E,v,w,x,T,b,y,g,H,R,M,S,O,z,P,_,j,C,I,N,k,D,V,W,L=[],J=[],G=[],B=0,F=!0,U=!1;h=new THREE.WebGLRenderer,f=new THREE.Scene,y=new THREE.Clock,E=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e4),E.position.set(0,0,0),E.target=f.position.clone(),h.setClearColor(new THREE.Color(16777215,1)),h.shadowMapEnabled=!0,h.setSize(window.innerWidth,window.innerHeight),d=document.getElementById("container-exp-1"),d.appendChild(h.domElement),d.focus(),f.add(E),g=new THREE.FirstPersonControls(E,d),g.lookSpeed=.05,g.movementSpeed=170,g.noFly=!1,g.activeLook=!0,g.lookVertical=!0,g.constrainVertical=!1,g.verticalMin=0,g.verticalMax=0,g.lon=-150,g.lat=120,$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=newMember",success:function(e){var o=$.parseJSON(e);U=o.new_member,U===!0&&(t(),$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=activeMember"}))},complete:function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setMatrix",success:function(t){for(I=$.parseJSON(t),N=I.position,P=N.length,i=0;P>i;i++){o();var n=e(N[i]),a=n[0].split(/,+/g);x.position.x=+a[0],x.position.y=+a[1],x.position.z=+a[2],x.name=i+1,L.push(x)}if(void 0!=I.user_a)for(i=0;i<I.user_a.length;i++){V=I.user_a[i],W=I.user_b[i];var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(L[+V].position.x,L[+V].position.y,L[+V].position.z),new THREE.Vector3(L[+W].position.x,L[+W].position.y,L[+W].position.z));for(var s=0;s<r.vertices.length;s++)r.colors[s]=new THREE.Color(Math.random(),Math.random(),Math.random());var l=new THREE.Line(r,new THREE.LineBasicMaterial({transparent:!0,opacity:.2,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);f.add(l)}p(),c()},complete:function(e){z=+I.ID;var t=L[z];t.material.wireframe=!0,t.material.wireframeLinewidth=1,t.material.opacity=.2,t.scale.x,t.scale.y,t.scale.z=3,M=new TWEEN.Tween({x:E.position.x,y:E.position.y,z:E.position.z}).to({x:t.position.x,y:t.position.y,z:t.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){E.position.x=this.x,E.position.y=this.y,E.position.z=this.z}).onComplete(function(){U===!0&&a("welcome")}).start()}})}});var q=new THREE.MeshPhongMaterial({color:6052956,ambient:15132390,emissive:3618615,specular:8224125}),A=new THREE.Mesh(new THREE.BoxGeometry(20,20,20),q);A.position.set(0,0,0),A.name="logout",f.add(A),L.push(A),h.render(f,E),$(d).click(function(e){e.preventDefault();var t=new THREE.Vector3(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1,.5);t=t.unproject(E);var o=new THREE.Raycaster(E.position,t.sub(E.position).normalize()),n=o.intersectObjects(G);if(n.length>0&&n[0].object!=L[z]){var i=n[0].object;_=i.name,"logout"==_?$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}}):(console.log("ID Forme sélectionnée : "+_),console.log("ID personnel : "+z),$.ajax({url:"espace-membre/script.php",type:"POST",data:{name_object:_,action:"createDiscussion"},success:function(e){var t=$.parseJSON(e);C=t.id_conversation,console.log("ID conversation : "+C),j=setInterval(r,3e3),clearInterval(X)}}),E.position.x!=i.position.x&&E.position.y!=i.position.y?M=new TWEEN.Tween({x:E.position.x,y:E.position.y,z:E.position.z}).to({x:i.position.x,y:i.position.y,z:i.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){E.position.x=this.x,E.position.y=this.y,E.position.z=this.z}).onComplete(function(){E.rotation=i.position,a("chat");var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(L[z].position.x,L[z].position.y,L[z].position.z),new THREE.Vector3(i.position.x,i.position.y,i.position.z));for(var t=0;t<e.vertices.length;t++)e.colors[t]=new THREE.Color(Math.random(),Math.random(),Math.random());var o=new THREE.Line(e,new THREE.LineBasicMaterial({transparent:!0,opacity:.3,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);f.add(o)}).start():a("chat"))}}),$(".md-close").click(function(){return X=setInterval(s,1e4),clearInterval(j),g.lookSpeed=.05,$("#container-exp-1").css({"-webkit-filter":"blur(0px)","-moz-filter":"blur(0px)","-ms-filter":"blur(0px)","-o-filter":"blur(0px)",filter:"blur(0px)"}),$(".chatroom li").remove(),$(".modal-chat").fadeOut(400),$(".modal-welcome").fadeOut(400),l(),d.focus(),!1}),$(".disconnect").click(function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}})}),$("#chatForm").submit(function(e){e.preventDefault();var t=$("#message").val();return R=1,t.length>130?($(".text-lenght").html(t.length),$(".error-length").fadeIn(400),!1):(""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{message:t,action:"sendMessage",id_conversation:C,notif:R,name_object:_},success:function(e){r(),$("#message").val(""),$("#message").focus()}})),$(".chatroom li").length>=1&&$(".chatroom li:first-child").remove(),!1)});var X=setInterval(s,1e4);setInterval(function(){c(),p()},1e4),$(".left-button").click(function(){C=k,clearInterval(X),j=setInterval(r,3e3),$(".popup").fadeOut(400),a("chat"),l()}),$(".right-button").click(function(){$(".popup").fadeOut(400),l()}),u(),THREEx.WindowResize(h,E);var Y,K;$("body").mouseleave(function(e){Y=0,K=0,console.log(Y)}),$("body").mouseenter(function(e){Y=1,K=1,console.log(Y)}),window.onbeforeunload=m});
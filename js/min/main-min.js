$(document).ready(function(){function e(e){var t=e.substring(1,e.length-1),n=t.split(/],\[+/g);return n}function t(){M=[];var e=600*Math.random(),t=600*Math.random(),n=600*Math.random();M.push(e,t,n),S=JSON.stringify(M),$.ajax({url:"espace-membre/script.php",type:"POST",data:{userPosition:S,action:"setPositionShape"},complete:function(e,t){console.log(t)}})}function n(){T=[];for(var e=0;4>e;e++){var t=-15+Math.round(30*Math.random()),n=-15+Math.round(30*Math.random()),i=-15+Math.round(30*Math.random());T.push(new THREE.Vector3(t,n,i))}o()}function o(){v=new THREE.Object3D;var e=new THREE.MeshBasicMaterial({color:16777215,transparent:!1});T.forEach(function(t){var n=new THREE.SphereGeometry(.2),o=new THREE.Mesh(n,e);o.position.copy(t),v.add(o)}),b=new THREE.ConvexGeometry(T),w=new THREE.Mesh(b,new THREE.MeshNormalMaterial({color:15263976,transparent:!0,opacity:.08})),d.add(w)}function a(e){"chat"==e?$(".container-modal-chat").fadeIn(400):"welcome"==e&&$(".modal-welcome").fadeIn(400),x.lookSpeed=.01}function r(){return $.ajax({url:"espace-membre/script.php",type:"POST",data:{action:"getMessage",id_conversation:j,lastid:F},success:function(e){var t=$.parseJSON(e);null!=t.msg&&null!=t.id&&($(".chatroom").append("<li>"+t.msg+"</li>"),F=t.id),$(".chatroom li").length>1&&$(".chatroom li:first-child").remove()}}),!1}function s(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=getNotification",success:function(e){var t=$.parseJSON(e);null!=t&&(console.log("Notification : "+t.id_room[0]),C=t.id_room[0],$(".popup").fadeIn(400))}})}function c(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isConnected",success:function(e){var t=$.parseJSON(e),n=t.user_connected;for(L=[],L.push(q),i=0;i<n.length;i++){var o=n[i];L.push(W[o]),L[i].material.opacity=.2}}})}function p(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setStatistics",success:function(e){var t=$.parseJSON(e),n=t.nbr_shapes,o=t.nbr_shapes_connected,i=t.nbr_link_created,a=t.nbr_linkPerso_created,r=t.nbr_msg_sended;$(".chiffre1").html(n),$(".chiffre2").html(o),$(".chiffre3").html(i),$(".chiffre4").html(a),$(".chiffre5").html(r)}})}function l(){$.ajax({url:"espace-membre/script.php",type:"POST",data:{ID:O,action:"removeNotif"}})}function m(){requestAnimationFrame(m),g=y.getDelta(),x.update(g),TWEEN.update(),h.clear(),h.render(d,f)}var u,h,d,f,E,v,w,T,g,y,x,b,H,R,M,S,O,I,_,P,j,z,N,C,k,D,V,W=[],J=[],L=[],F=0,G=!0,B=!1;h=new THREE.WebGLRenderer,d=new THREE.Scene,y=new THREE.Clock,f=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e4),f.position.set(0,0,0),f.target=d.position.clone(),h.setClearColor(new THREE.Color(16777215,1)),h.shadowMapEnabled=!0,h.setSize(window.innerWidth,window.innerHeight),u=document.getElementById("container-exp-1"),u.appendChild(h.domElement),u.focus(),d.add(f),x=new THREE.FirstPersonControls(f,u),x.lookSpeed=.05,x.movementSpeed=170,x.noFly=!1,x.activeLook=!0,x.lookVertical=!0,x.constrainVertical=!1,x.verticalMin=0,x.verticalMax=0,x.lon=-150,x.lat=120,$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=newMember",success:function(e){var n=$.parseJSON(e);B=n.new_member,B===!0&&(t(),$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=activeMember"}))},complete:function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=setMatrix",success:function(t){for(z=$.parseJSON(t),N=z.position,I=N.length,i=0;I>i;i++){n();var o=e(N[i]),a=o[0].split(/,+/g);w.position.x=+a[0],w.position.y=+a[1],w.position.z=+a[2],w.name=i+1,W.push(w)}if(void 0!=z.user_a)for(i=0;i<z.user_a.length;i++){D=z.user_a[i],V=z.user_b[i];var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(W[+D].position.x,W[+D].position.y,W[+D].position.z),new THREE.Vector3(W[+V].position.x,W[+V].position.y,W[+V].position.z));for(var s=0;s<r.vertices.length;s++)r.colors[s]=new THREE.Color(Math.random(),Math.random(),Math.random());var l=new THREE.Line(r,new THREE.LineBasicMaterial({transparent:!0,opacity:.2,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);d.add(l)}p(),c()},complete:function(e){O=+z.ID;var t=W[O];t.material.wireframe=!0,t.material.wireframeLinewidth=1,t.material.opacity=.2,t.scale.x,t.scale.y,t.scale.z=3,R=new TWEEN.Tween({x:f.position.x,y:f.position.y,z:f.position.z}).to({x:t.position.x,y:t.position.y,z:t.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){f.position.x=this.x,f.position.y=this.y,f.position.z=this.z}).onComplete(function(){B===!0&&a("welcome")}).start()}})}});var U=new THREE.MeshPhongMaterial({color:6052956,ambient:15132390,emissive:3618615,specular:8224125}),q=new THREE.Mesh(new THREE.BoxGeometry(20,20,20),U);q.position.set(0,0,0),q.name="logout",d.add(q),W.push(q),h.render(d,f),$(u).click(function(e){e.preventDefault();var t=new THREE.Vector3(e.clientX/window.innerWidth*2-1,2*-(e.clientY/window.innerHeight)+1,.5);t=t.unproject(f);var n=new THREE.Raycaster(f.position,t.sub(f.position).normalize()),o=n.intersectObjects(W);if(o.length>0&&o[0].object!=W[O]){var i=o[0].object;_=i.name,"logout"==_?$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}}):(console.log("ID Forme sélectionnée : "+_),console.log("ID personnel : "+O),$.ajax({url:"espace-membre/script.php",type:"POST",data:{name_object:_,action:"createDiscussion"},success:function(e){$("#fiche").html("");var t=$.parseJSON(e),n=t.information;j=t.id_conversation,console.log(n),null!=n?($("#fiche").html(""),$("#fiche").val(n),console.log("Information fiche : "+n)):$("#fiche").val(""),console.log("ID conversation : "+j),P=setInterval(r,3e3),clearInterval(A)}}),f.position.x!=i.position.x&&f.position.y!=i.position.y?R=new TWEEN.Tween({x:f.position.x,y:f.position.y,z:f.position.z}).to({x:i.position.x,y:i.position.y,z:i.position.z},2e3).easing(TWEEN.Easing.Sinusoidal.In).onUpdate(function(){f.position.x=this.x,f.position.y=this.y,f.position.z=this.z}).onComplete(function(){f.rotation=i.position,a("chat");var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(W[O].position.x,W[O].position.y,W[O].position.z),new THREE.Vector3(i.position.x,i.position.y,i.position.z));for(var t=0;t<e.vertices.length;t++)e.colors[t]=new THREE.Color(Math.random(),Math.random(),Math.random());var n=new THREE.Line(e,new THREE.LineBasicMaterial({transparent:!0,opacity:.3,color:16777215,vertexColors:THREE.VertexColors}),THREE.LinePieces);d.add(n)}).start():a("chat"))}}),$(".md-close").click(function(){return A=setInterval(s,1e4),clearInterval(P),x.lookSpeed=.05,$(".chatroom li").remove(),$(".container-modal-chat").fadeOut(400),$(".modal-welcome").fadeOut(400),l(),u.focus(),!1}),$(".disconnect").click(function(){$.ajax({url:"espace-membre/script.php",type:"POST",data:"action=isNotConnected",success:function(e){document.location.href="espace-membre/deconnexion.php"}})}),$("#chatForm").submit(function(e){e.preventDefault();var t=$("#message").val();return H=1,t.length>130?($(".text-lenght").html(t.length),$(".error-length").fadeIn(400),!1):(""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{message:t,action:"sendMessage",id_conversation:j,notif:H,name_object:_},success:function(e){r(),$("#message").val(""),$("#message").focus()}})),$(".chatroom li").length>=1&&$(".chatroom li:first-child").remove(),!1)}),$("#chatFiche").submit(function(e){e.preventDefault();var t=$("#fiche").val();return t.length>430?($(".text-lenght").html(t.length),$(".error-length").fadeIn(400),!1):void(""!=t&&($(".error-length").fadeOut(400),$.ajax({url:"espace-membre/script.php",type:"POST",data:{information:t,action:"setInformation",id_conversation:j},success:function(e){var e=$.parseJSON(e),t=e.infos;$(".save-informations").fadeIn(400).delay(5e3).fadeOut(400)}})))});var A=setInterval(s,1e4);setInterval(function(){c(),p()},1e4),$(".left-button").click(function(){j=C,clearInterval(A),P=setInterval(r,3e3),$(".popup").fadeOut(400),a("chat"),l()}),$(".right-button").click(function(){$(".popup").fadeOut(400),l()}),m(),THREEx.WindowResize(h,f)});